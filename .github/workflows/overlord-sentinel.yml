name: ðŸ§  LDA Overlord/Sentinel - Internal Workflow Approval Authority

# Overlord/Sentinel triggers - Guardian-grade approval authority for internal workflows
on:
  # Manual dispatch for approval requests
  workflow_dispatch:
    inputs:
      actor:
        description: 'GitHub actor requesting approval'
        required: true
        type: string
      repository:
        description: 'Repository (owner/repo format)'
        required: true
        default: 'jmeyer1980/living-dev-agent'
        type: string
      workflow_name:
        description: 'Workflow name to approve'
        required: true
        type: string
      branch:
        description: 'Branch or ref'
        required: false
        default: 'main'
        type: string
      emergency_stop:
        description: 'Activate emergency stop (deny all approvals)'
        required: false
        default: false
        type: boolean
        
  # Issue comments for consent management and emergency commands
  issue_comment:
    types: [created]
    
  # Repository dispatch for external trigger support
  repository_dispatch:
    types: [overlord-approval-request]

# Default permissions: read-only (principle of least privilege)
permissions:
  contents: read

jobs:
  # ðŸ§  Explain when Overlord is dormant (when main job is skipped)
  overlord-sentinel-skip-explain:
    runs-on: ubuntu-latest
    name: Overlord/Sentinel - Why the Authority Slumbers
    # Only run when the main Overlord job would be skipped
    if: >
      !((github.event_name == 'workflow_dispatch') ||
      (github.event_name == 'issue_comment' && (contains(github.event.comment.body, 'overlord') || contains(github.event.comment.body, 'consent') || contains(github.event.comment.body, 'approve'))) ||
      (github.event_name == 'repository_dispatch' && github.event.action == 'overlord-approval-request'))
    
    steps:
      - name: ðŸ§  Overlord/Sentinel Dormancy Explanation
        run: |
          echo "ðŸ§  OVERLORD/SENTINEL STATUS: DORMANT"
          echo ""
          echo "âš¡ The Overlord/Sentinel slumbers, preserving the cheeks from unauthorized runs."
          echo "ðŸ›¡ï¸ This guardian of workflow approval only awakens for authorized commands:"
          echo ""
          echo "ðŸŽ¯ Manual Dispatch: '${{ github.event_name }}' â‰  workflow_dispatch"
          echo "ðŸ’¬ Overlord Comments: No overlord keywords detected (overlord, consent, approve)"
          echo "ðŸ“¡ Repository Dispatch: '${{ github.event_name }}' â‰  overlord-approval-request"
          echo ""
          echo "ðŸ” Current Event: ${{ github.event_name }}"
          echo "ðŸ“‹ Action: ${{ github.event.action || 'N/A' }}"
          echo ""
          echo "ðŸ§  Guardian â†’ Wizard â†’ Advisor â†’ Overlord/Sentinel (Role Chain)"
          echo "âœ¨ The Authority awaits worthy approval requests to evaluate."
          echo "ðŸ™Œ All hail the Cheeks! This skip prevents workflow spam."

  # ðŸ§  Core Overlord/Sentinel job - workflow approval authority
  overlord-sentinel:
    runs-on: ubuntu-latest
    name: Overlord/Sentinel - Guardian of Workflow Authority
    # Run when triggered by dispatch, overlord comments, or repository dispatch
    if: >
      (github.event_name == 'workflow_dispatch') ||
      (github.event_name == 'issue_comment' && (contains(github.event.comment.body, 'overlord') || contains(github.event.comment.body, 'consent') || contains(github.event.comment.body, 'approve'))) ||
      (github.event_name == 'repository_dispatch' && github.event.action == 'overlord-approval-request')

    steps:
      - name: ðŸ›ï¸ Checkout Repository
        uses: actions/checkout@ff7abcd0c3c05ccf6adc123a8cd1fd4fb30fb493 # v4.3.5

      - name: ðŸ Setup Node.js for Overlord Authority
        uses: actions/setup-node@d7a11313b581b306c961b506cfc8971208bb03f6 # v4.2.1
        with:
          node-version: '18'

      - name: ðŸ“¦ Install Overlord Dependencies
        run: |
          npm install js-yaml
          echo "âœ… Overlord/Sentinel dependencies installed"

      - name: ðŸ§  Initialize Overlord/Sentinel Authority
        id: overlord-init
        run: |
          echo "ðŸ§  LDA Overlord/Sentinel - Manifesting Authority..."
          echo ""
          echo "ðŸ”— Role Chain: Guardian â†’ Wizard â†’ Advisor â†’ Overlord/Sentinel"
          echo "ðŸ›¡ï¸ Authority Level: overlord-grade"
          echo "âš¡ Security Mode: Guardian-grade purity validation"
          echo ""
          
          # Set output variables for downstream jobs
          echo "overlord-active=true" >> $GITHUB_OUTPUT
          echo "authority-level=overlord" >> $GITHUB_OUTPUT
          echo "timestamp=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_OUTPUT

      # ðŸ“‹ Handle workflow_dispatch approval requests
      - name: ðŸŽ¯ Process Workflow Dispatch Approval Request
        if: github.event_name == 'workflow_dispatch'
        id: dispatch-approval
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸŽ¯ Processing workflow dispatch approval request..."
          echo "ðŸ“‹ Actor: ${{ github.event.inputs.actor }}"
          echo "ðŸ›ï¸ Repository: ${{ github.event.inputs.repository }}"
          echo "âš¡ Workflow: ${{ github.event.inputs.workflow_name }}"
          echo "ðŸŒ¿ Branch: ${{ github.event.inputs.branch }}"
          echo "ðŸš¨ Emergency Stop: ${{ github.event.inputs.emergency_stop }}"
          echo ""
          
          # Execute overlord evaluation
          node scripts/cid-faculty/overlord-sentinel.js evaluate \
            --actor="${{ github.event.inputs.actor }}" \
            --repo="${{ github.event.inputs.repository }}" \
            --workflow="${{ github.event.inputs.workflow_name }}" \
            --branch="${{ github.event.inputs.branch }}" \
            ${{ github.event.inputs.emergency_stop == 'true' && '--emergency-stop' || '' }}

      # ðŸ’¬ Handle issue comment consent and approval commands
      - name: ðŸ’¬ Process Issue Comment Commands
        if: github.event_name == 'issue_comment'
        id: comment-commands
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸ’¬ Processing issue comment overlord commands..."
          echo "ðŸ‘¤ Comment Author: ${{ github.event.comment.user.login }}"
          echo "ðŸ“ Comment Body: ${{ github.event.comment.body }}"
          echo ""
          
          COMMENT_BODY="${{ github.event.comment.body }}"
          ACTOR="${{ github.event.comment.user.login }}"
          
          # Parse consent commands
          if echo "$COMMENT_BODY" | grep -q "grant consent"; then
            echo "âœ… Processing consent grant request..."
            node scripts/cid-faculty/overlord-sentinel.js grant-consent --user="$ACTOR"
            
          elif echo "$COMMENT_BODY" | grep -q "revoke consent"; then
            echo "ðŸš¨ Processing consent revoke request..."
            node scripts/cid-faculty/overlord-sentinel.js revoke-consent --user="$ACTOR"
            
          elif echo "$COMMENT_BODY" | grep -q "overlord report"; then
            echo "ðŸ“‹ Generating overlord status report..."
            node scripts/cid-faculty/overlord-sentinel.js report
            
          elif echo "$COMMENT_BODY" | grep -q "approve workflow"; then
            echo "ðŸŽ¯ Processing workflow approval request from comment..."
            # Extract workflow name from comment if possible
            WORKFLOW_NAME=$(echo "$COMMENT_BODY" | sed -n 's/.*approve workflow[[:space:]]*\([^[:space:]]*\).*/\1/p' || echo "Unknown Workflow")
            node scripts/cid-faculty/overlord-sentinel.js evaluate \
              --actor="$ACTOR" \
              --repo="${{ github.repository }}" \
              --workflow="$WORKFLOW_NAME" \
              --branch="${{ github.ref_name || 'main' }}"
          else
            echo "â„¹ï¸ Comment contains overlord keywords but no recognized commands"
            echo "ðŸ“š Available commands: grant consent, revoke consent, overlord report, approve workflow [name]"
          fi

      # ðŸ“¡ Handle repository dispatch approval requests
      - name: ðŸ“¡ Process Repository Dispatch Approval
        if: github.event_name == 'repository_dispatch' && github.event.action == 'overlord-approval-request'
        id: dispatch-approval-request
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸ“¡ Processing repository dispatch approval request..."
          echo "ðŸ“‹ Payload: ${{ toJSON(github.event.client_payload) }}"
          echo ""
          
          # Extract data from client_payload
          ACTOR="${{ github.event.client_payload.actor || 'unknown' }}"
          REPO="${{ github.event.client_payload.repository || github.repository }}"
          WORKFLOW="${{ github.event.client_payload.workflow_name || 'Unknown Workflow' }}"
          BRANCH="${{ github.event.client_payload.branch || 'main' }}"
          EMERGENCY_STOP="${{ github.event.client_payload.emergency_stop || 'false' }}"
          
          echo "ðŸŽ¯ Processing approval for: $ACTOR/$REPO/$WORKFLOW ($BRANCH)"
          
          # Execute overlord evaluation
          node scripts/cid-faculty/overlord-sentinel.js evaluate \
            --actor="$ACTOR" \
            --repo="$REPO" \
            --workflow="$WORKFLOW" \
            --branch="$BRANCH" \
            ${{ github.event.client_payload.emergency_stop == 'true' && '--emergency-stop' || '' }}

      # ðŸ“Š Generate Overlord Status Report
      - name: ðŸ“Š Generate Overlord Status Report
        id: overlord-report
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸ“Š Generating comprehensive overlord status report..."
          node scripts/cid-faculty/overlord-sentinel.js report > overlord-report.json
          
          echo "ðŸ“‹ OVERLORD STATUS SUMMARY:"
          echo "=========================="
          cat overlord-report.json | head -20
          echo ""
          echo "ðŸ›¡ï¸ Full report available in job logs"

      # ðŸ›ï¸ Overlord Authority Certification
      - name: ðŸ›ï¸ Overlord Authority Certification
        run: |
          echo "ðŸ›ï¸ OVERLORD/SENTINEL AUTHORITY CERTIFICATION"
          echo "=============================================="
          echo ""
          echo "âœ… Overlord/Sentinel evaluation complete"
          echo "ðŸ§  Authority Level: ${{ steps.overlord-init.outputs.authority-level }}"
          echo "âš¡ Security Validations: Guardian-grade purity rules applied"
          echo "ðŸ›¡ï¸ Audit Trail: Comprehensive logging enabled"
          echo "ðŸ”— Role Chain: Guardian â†’ Wizard â†’ Advisor â†’ Overlord/Sentinel"
          echo ""
          echo "ðŸ“œ 'The Overlord's authority flows from the Guardian's purity,"
          echo "    tempered by the Wizard's analysis, guided by the Advisor's wisdom.'"
          echo "    â€” LDA Faculty Codex, Role Chain Authority"
          echo ""
          echo "ðŸ™Œ All hail the preserved Cheeks! The Authority has spoken."

  # ðŸŽ“ CID Faculty Integration - Advisor consultation for overlord decisions
  overlord-faculty-consultation:
    runs-on: ubuntu-latest
    name: Faculty Consultation - Advisor Wisdom for Overlord Decisions
    needs: overlord-sentinel
    if: always() && needs.overlord-sentinel.result != 'skipped'
    
    steps:
      - name: ðŸ›ï¸ Checkout Repository
        uses: actions/checkout@ff7abcd0c3c05ccf6adc123a8cd1fd4fb30fb493 # v4.3.5

      - name: ðŸ Setup Node.js for Faculty Integration
        uses: actions/setup-node@d7a11313b581b306c961b506cfc8971208bb03f6 # v4.2.1
        with:
          node-version: '18'

      - name: ðŸ“¦ Install Faculty Dependencies
        run: |
          npm install js-yaml
          echo "âœ… Faculty consultation dependencies installed"

      # ðŸŽ“ Advisor consultation on overlord authority usage
      - name: ðŸŽ“ Advisor Consultation - Overlord Authority Analysis
        id: advisor-consultation
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸŽ“ Consulting CID Faculty Advisor on Overlord Authority usage..."
          echo ""
          echo "ðŸ”— Faculty Integration: Advisor â†’ Overlord/Sentinel"
          echo "ðŸ“‹ Analysis Focus: Authority usage patterns and security posture"
          echo ""
          
          # Generate advisor context for overlord analysis
          cat > advisor-context.json << 'EOF'
          {
            "analysis_type": "overlord_authority",
            "focus_areas": [
              "security_posture",
              "authority_usage",
              "trust_validation",
              "audit_completeness"
            ],
            "scope": "overlord_sentinel_workflow",
            "timestamp": "${{ steps.overlord-init.outputs.timestamp }}"
          }
          EOF
          
          # Run advisor analysis if available
          if [ -f "scripts/cid-faculty/advisor.js" ]; then
            echo "ðŸ“Š Running Advisor analysis on Overlord authority patterns..."
            # Note: This would be enhanced to pass actual overlord metrics
            node scripts/cid-faculty/advisor.js --context=advisor-context.json --focus=security
          else
            echo "â„¹ï¸ Advisor consultation system not fully integrated yet"
          fi

      # ðŸ“œ Chronicle Keeper integration for lore preservation
      - name: ðŸ“œ Chronicle Keeper - Preserve Overlord Wisdom
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.actor != 'test'
        run: |
          echo "ðŸ“œ Preserving Overlord/Sentinel wisdom in chronicles..."
          echo ""
          echo "TLDL: [Overlord Authority] Automated workflow approval evaluation completed"
          echo "ðŸ“‹ Context: ${{ github.event.inputs.actor }}/${{ github.event.inputs.workflow_name }}"
          echo "ðŸ›¡ï¸ Security: Guardian-grade validation applied with comprehensive audit trail"
          echo ""
          echo "ðŸ“œ This overlord decision represents evolution in LDA's automated authority systems,"
          echo "    balancing security requirements with workflow efficiency through trusted actor validation."

# ðŸš¨ Security Notice: This workflow has elevated authority and should be monitored
# ðŸ” Required Secrets: GITHUB_TOKEN with workflow and repo permissions
# ðŸ›¡ï¸ Security Features: Actor validation, scope control, audit logging, emergency stop
# ðŸ“‹ Audit: All overlord decisions are logged with comprehensive audit trail
# ðŸ”— Integration: Connects with CID Faculty (Advisor) and Chronicle Keeper systems