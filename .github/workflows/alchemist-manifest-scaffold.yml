---
name: 🧙‍♂️ Alchemist Manifest Scaffold

# Automatically generates experiment manifests when Gu Pot issues are labeled
# as 'distilled'. Uses the existing Python script to create manifests in
# experiments/gu_pot/issue-<number>/
'on':
  issues:
    types: [labeled]

# Security and concurrency controls
concurrency:
  group: ${{ github.workflow }}-${{ github.event.issue.number }}
  cancel-in-progress: true

jobs:
  scaffold-manifest:
    name: 🧪 Generate Experiment Manifest
    runs-on: ubuntu-latest

    # Only run if the issue was labeled with something containing 'distilled'
    if: contains(github.event.label.name, 'distilled')

    steps:
      - name: Checkout repository
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955
        with:
          # Need full history to commit back
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: |
          echo "🧙‍♂️ Installing Alchemist Faculty dependencies..."
          python -m pip install --upgrade pip
          pip install PyYAML>=6.0 requests>=2.25.0
          echo "✅ Dependencies installed successfully"

      - name: Create experiments directory
        run: |
          echo "📁 Ensuring experiments directory structure exists..."
          mkdir -p experiments/gu_pot
          echo "✅ Directory structure ready"

      - name: Generate experiment manifest
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "🧪 Generating manifest for issue #${{ github.event.issue.number }}..."

          # Set output directory
          OUTPUT_DIR="experiments/gu_pot/issue-${{ github.event.issue.number }}"

          # Generate manifest using the existing Python script
          python3 scripts/alchemist-faculty/generate_manifest.py \
            --issue-url "${{ github.event.issue.html_url }}" \
            --output "$OUTPUT_DIR" \
            --format yaml \
            --github-token "$GITHUB_TOKEN" \
            --verbose

          echo "✅ Manifest generated in $OUTPUT_DIR"

      - name: Commit and push manifest
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "📝 Committing generated manifest..."

          # Configure git
          git config --local user.email "action@github.com"
          git config --local user.name "Alchemist Faculty Bot"

          # Check if there are changes to commit
          if git diff --quiet && git diff --staged --quiet; then
            echo "⚠️ No manifest changes to commit"
            exit 0
          fi

          # Add and commit the manifest files
          git add experiments/gu_pot/issue-${{ github.event.issue.number }}/
          git commit -m "🧪 Generate Alchemist manifest for issue #${{ github.event.issue.number }}

          Auto-generated experiment manifest for Gu Pot issue labeled as 'distilled'.

          - Issue: ${{ github.event.issue.title }}
          - Label: ${{ github.event.label.name }}
          - Manifest: experiments/gu_pot/issue-${{ github.event.issue.number }}/manifest_v1.yaml"

          # Push the changes
          git push
          echo "✅ Manifest committed and pushed successfully"

      - name: Comment on issue
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea
        with:
          script: |
            const issueNumber = ${{ github.event.issue.number }};
            const manifestPath = `experiments/gu_pot/issue-${issueNumber}/manifest_v1.yaml`;

            const comment = `🧪 **Alchemist Faculty Manifest Generated**

            Your Gu Pot issue has been labeled as **distilled** and an experiment manifest has been automatically generated!

            📁 **Manifest Location**: \`${manifestPath}\`
            🔗 **View Manifest**: [manifest_v1.yaml](../blob/main/${manifestPath})

            The manifest includes:
            - 🎯 Experimental context and hypothesis
            - 🔗 Origin binding to this issue
            - 📊 Validation criteria for evidence evaluation
            - ⚙️ Execution configuration for reproducible experiments

            **Next Steps:**
            - Review the generated manifest for accuracy
            - Execute the experiment using Alchemist Faculty tools
            - Update this issue with experimental evidence
            - Progress to validation and promotion stages

            *Generated by Alchemist Faculty Bot 🧙‍♂️*`;

            await github.rest.issues.createComment({
              issue_number: issueNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Handle errors
        if: failure()
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea
        with:
          script: |
            const comment = `❌ **Alchemist Manifest Generation Failed**

            There was an error generating the experiment manifest for this issue.

            **Possible causes:**
            - Issue does not contain valid Gu Pot structure
            - GitHub API access issues
            - Python script execution errors

            **Manual Generation:**
            You can manually generate the manifest using:
            \`\`\`bash
            python3 scripts/alchemist-faculty/generate_manifest.py \\
              --issue-url ${{ github.event.issue.html_url }} \\
              --output experiments/gu_pot/issue-${{ github.event.issue.number }} \\
              --format yaml
            \`\`\`

            Please check the workflow logs for detailed error information.

            *Alchemist Faculty Bot 🧙‍♂️*`;

            await github.rest.issues.createComment({
              issue_number: ${{ github.event.issue.number }},
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });