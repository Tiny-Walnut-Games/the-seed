name: ðŸ¤– Dependabot Auto-Merge

on:
  pull_request_target:
    types: [opened, labeled, synchronize, reopened]
  workflow_dispatch:

env:
  # Set to true to enable auto-merge by default (without ritual-auto label)
  # Default: false for safety - requires manual "ritual-auto" label
  DEFAULT_AUTOMERGE: false

jobs:
  dependabot-automerge:
    name: Auto-merge Dependabot PRs
    runs-on: ubuntu-latest
    # Only run on dependabot PRs to avoid security issues
    if: github.actor == 'dependabot[bot]'
    
    permissions:
      contents: write
      pull-requests: write
      
    # Prevent race conditions when multiple events trigger simultaneously
    concurrency:
      group: dependabot-automerge-${{ github.event.pull_request.number }}
      cancel-in-progress: true

    steps:
      - name: ðŸ” Check PR eligibility
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_LABELS: ${{ toJSON(github.event.pull_request.labels.*.name) }}
        run: |
          echo "ðŸ¤– Evaluating Dependabot PR #$PR_NUMBER for auto-merge eligibility..."
          
          # Check for explicit blocking label
          if echo '${{ env.PR_LABELS }}' | jq -r '.[]' | grep -q "no-automerge"; then
            echo "âŒ PR has 'no-automerge' label - skipping auto-merge"
            echo "eligible=false" >> $GITHUB_OUTPUT
            echo "reason=blocked-by-label" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Check if auto-merge should be enabled
          has_ritual_auto=$(echo '${{ env.PR_LABELS }}' | jq -r '.[]' | grep -c "ritual-auto" || true)
          default_enabled="${{ env.DEFAULT_AUTOMERGE }}"
          
          if [[ "$has_ritual_auto" -gt 0 ]] || [[ "$default_enabled" == "true" ]]; then
            echo "âœ… PR eligible for auto-merge"
            echo "eligible=true" >> $GITHUB_OUTPUT
            if [[ "$has_ritual_auto" -gt 0 ]]; then
              echo "reason=ritual-auto-label" >> $GITHUB_OUTPUT
            else
              echo "reason=default-enabled" >> $GITHUB_OUTPUT
            fi
          else
            echo "â„¹ï¸  PR not eligible - requires 'ritual-auto' label or DEFAULT_AUTOMERGE=true"
            echo "eligible=false" >> $GITHUB_OUTPUT
            echo "reason=requires-label" >> $GITHUB_OUTPUT
          fi

      - name: ðŸŽ¯ Check PR status
        id: status
        if: steps.check.outputs.eligible == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          echo "ðŸ” Checking PR status and reviews..."
          
          # Get PR details
          pr_data=$(gh api /repos/${{ github.repository }}/pulls/$PR_NUMBER)
          mergeable=$(echo "$pr_data" | jq -r '.mergeable')
          draft=$(echo "$pr_data" | jq -r '.draft')
          
          # Check if PR is in draft
          if [[ "$draft" == "true" ]]; then
            echo "âŒ PR is in draft state"
            echo "ready=false" >> $GITHUB_OUTPUT
            echo "reason=draft" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Check if PR is mergeable
          if [[ "$mergeable" == "false" ]]; then
            echo "âŒ PR has merge conflicts"
            echo "ready=false" >> $GITHUB_OUTPUT
            echo "reason=conflicts" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Check CI status
          checks_url="/repos/${{ github.repository }}/commits/${{ github.event.pull_request.head.sha }}/check-runs"
          checks=$(gh api "$checks_url" --jq '.check_runs[] | select(.status == "completed") | .conclusion')
          
          failed_checks=$(echo "$checks" | grep -c "failure" || true)
          if [[ $failed_checks -gt 0 ]]; then
            echo "âŒ PR has failing checks"
            echo "ready=false" >> $GITHUB_OUTPUT
            echo "reason=failing-checks" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          pending_checks=$(gh api "$checks_url" --jq '.check_runs[] | select(.status != "completed") | .name' || true)
          if [[ -n "$pending_checks" ]]; then
            echo "â³ PR has pending checks: $pending_checks"
            echo "ready=false" >> $GITHUB_OUTPUT
            echo "reason=pending-checks" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "âœ… PR is ready for auto-merge"
          echo "ready=true" >> $GITHUB_OUTPUT

      - name: ðŸš€ Enable auto-merge
        if: steps.check.outputs.eligible == 'true' && steps.status.outputs.ready == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          echo "ðŸš€ Enabling auto-merge for PR #$PR_NUMBER..."
          
          # Enable auto-merge with squash strategy
          gh api -X PUT /repos/${{ github.repository }}/pulls/$PR_NUMBER/merge \
            -f merge_method=squash \
            -f auto_merge=true
          
          echo "âœ… Auto-merge enabled! PR will merge when all checks pass."
          
          # Add a comment to document the auto-merge
          cat << 'EOF' | gh api /repos/${{ github.repository }}/issues/$PR_NUMBER/comments --input -
          {
            "body": "ðŸ¤– **RitualBot Auto-Merge Activated**\n\nThis Dependabot PR has been approved for auto-merge based on:\nâ€¢ **Trigger**: ${{ steps.check.outputs.reason }}\nâ€¢ **Strategy**: Squash merge\nâ€¢ **Safety**: Will only merge when all checks pass\n\nThe merge will happen automatically once all CI checks complete successfully. ðŸš€"
          }
          EOF

      - name: ðŸ“ Log skipped PR
        if: steps.check.outputs.eligible == 'false' || steps.status.outputs.ready == 'false'
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          eligible="${{ steps.check.outputs.eligible }}"
          ready="${{ steps.status.outputs.ready }}"
          check_reason="${{ steps.check.outputs.reason }}"
          status_reason="${{ steps.status.outputs.reason }}"
          
          echo "ðŸ“ PR #$PR_NUMBER not auto-merged:"
          
          if [[ "$eligible" == "false" ]]; then
            case "$check_reason" in
              "blocked-by-label")
                echo "  âŒ Explicitly blocked by 'no-automerge' label"
                ;;
              "requires-label")
                echo "  â„¹ï¸  Requires 'ritual-auto' label (DEFAULT_AUTOMERGE=false)"
                echo "  ðŸ’¡ Add 'ritual-auto' label to enable auto-merge"
                ;;
            esac
          elif [[ "$ready" == "false" ]]; then
            case "$status_reason" in
              "draft")
                echo "  ðŸ“ PR is in draft state"
                ;;
              "conflicts")
                echo "  âš¡ PR has merge conflicts"
                ;;
              "failing-checks")
                echo "  ðŸ”´ PR has failing CI checks"
                ;;
              "pending-checks")
                echo "  â³ Waiting for CI checks to complete"
                ;;
            esac
          fi

      - name: ðŸ›¡ï¸ Security summary
        if: always()
        run: |
          echo "ðŸ›¡ï¸ **RitualBot Auto-Merge Security Summary**"
          echo "- âœ… Only runs on dependabot[bot] actor PRs"
          echo "- âœ… Requires explicit approval (ritual-auto label OR config)"
          echo "- âœ… Respects 'no-automerge' blocking label"
          echo "- âœ… Waits for all CI checks to pass"
          echo "- âœ… Uses squash merge strategy"
          echo "- âœ… Least-privilege permissions (contents: write, pull-requests: write)"
          echo ""
          echo "Current config: DEFAULT_AUTOMERGE=${{ env.DEFAULT_AUTOMERGE }}"