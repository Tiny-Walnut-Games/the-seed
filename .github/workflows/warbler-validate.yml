name: ğŸ­ Warbler Validation

on:
  pull_request:
    paths:
      - 'packages/warbler-core/**'
      - 'packs/warbler-pack-**'
      - 'scripts/validate-warbler-pack.mjs'
      - 'scripts/simulate-warble.mjs'
      - 'package.json'
      - 'tsconfig.base.json'
  push:
    branches: [ main ]
    paths:
      - 'packages/warbler-core/**'
      - 'packs/warbler-pack-**'
  workflow_dispatch:

env:
  NODE_VERSION: '20'

jobs:
  warbler-validate:
    name: ğŸ” Validate Warbler System
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v3.6.0
      
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.0.1
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ğŸ“¦ Install dependencies
      run: |
        npm ci
        echo "ğŸ“Š Dependency installation complete"
        
    - name: ğŸ”¨ Build warbler-core
      run: |
        cd packages/warbler-core
        npm run build
        echo "âœ… Warbler core built successfully"
        
    - name: ğŸ§ª Test warbler-core
      run: |
        cd packages/warbler-core
        npm test
        echo "âœ… Warbler core tests passed"
        
    - name: ğŸ”¨ Build content packs
      run: |
        echo "Building warbler-pack-core..."
        cd packs/warbler-pack-core
        npm run build
        echo "âœ… Core pack built successfully"
        
        echo "Building warbler-pack-faction-politics..."
        cd ../warbler-pack-faction-politics
        npm run build
        echo "âœ… Politics pack built successfully"
        
    - name: âœ… Validate pack templates
      run: |
        echo "ğŸ” Validating warbler-pack-core templates..."
        node scripts/validate-warbler-pack.mjs packs/warbler-pack-core/pack/templates.json
        
        echo "ğŸ” Validating warbler-pack-faction-politics templates..."
        node scripts/validate-warbler-pack.mjs packs/warbler-pack-faction-politics/pack/templates.json
        
        echo "âœ… All pack validations passed"
        
    - name: ğŸ­ Run conversation simulation
      run: |
        echo "ğŸš€ Running warbler simulation..."
        node scripts/simulate-warble.mjs
        echo "âœ… Simulation completed successfully"
        
    - name: ğŸ“‹ System health check
      run: |
        echo "ğŸ” Checking workspace configuration..."
        npm run build --if-present
        npm run test --if-present
        
        echo "ğŸ“Š Warbler ecosystem status:"
        echo "- warbler-core: $(cd packages/warbler-core && node -e "console.log(require('./package.json').version)")"
        echo "- warbler-pack-core: $(cd packs/warbler-pack-core && node -e "console.log(require('./package.json').version)")" 
        echo "- warbler-pack-faction-politics: $(cd packs/warbler-pack-faction-politics && node -e "console.log(require('./package.json').version)")"
        
        echo "ğŸ¯ Foundation for auto-merge gating by RitualBot Phase 0 is ready!"
        
    - name: ğŸ‰ Success notification
      if: success()
      run: |
        echo "ğŸ­âœ¨ Warbler validation workflow completed successfully!"
        echo "Ready for Dependabot automation and RitualBot Phase 0 auto-merge gating."
        echo "All conversation templates validated and runtime simulation passed."
        
    - name: ğŸ“¤ Upload simulation artifacts
      if: always()
      uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.4.3  
      with:
        name: warbler-simulation-results
        path: |
          packages/warbler-core/dist/
          packs/*/dist/
        retention-days: 7