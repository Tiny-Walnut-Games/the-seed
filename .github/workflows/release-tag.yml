name: ğŸš€ Warbler Release

on:
  workflow_dispatch:
    inputs:
      publish_core:
        description: 'Publish warbler-core package'
        required: false
        default: false
        type: boolean
      publish_packs:
        description: 'Publish warbler content packs'
        required: false
        default: false  
        type: boolean
      dry_run:
        description: 'Dry run (test publishing without actually publishing)'
        required: false
        default: true
        type: boolean
      version_bump:
        description: 'Version bump type (if publishing)'
        required: false
        default: 'patch'
        type: choice
        options:
        - patch
        - minor
        - major

env:
  NODE_VERSION: '20'

jobs:
  validate-before-release:
    name: ğŸ” Pre-Release Validation
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v3.6.0
      
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.0.1
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        registry-url: 'https://registry.npmjs.org'
        
    - name: ğŸ“¦ Install dependencies
      run: npm ci
      
    - name: ğŸ”¨ Build all packages
      run: |
        cd packages/warbler-core && npm run build
        cd ../../packs/warbler-pack-core && npm run build
        cd ../warbler-pack-faction-politics && npm run build
        
    - name: ğŸ§ª Run tests
      run: |
        cd packages/warbler-core && npm test
        
    - name: âœ… Validate templates
      run: |
        node scripts/validate-warbler-pack.mjs packs/warbler-pack-core/pack/templates.json
        node scripts/validate-warbler-pack.mjs packs/warbler-pack-faction-politics/pack/templates.json
        
    - name: ğŸ­ Run simulation
      run: node scripts/simulate-warble.mjs

  publish-core:
    name: ğŸ“¦ Publish Warbler Core
    runs-on: ubuntu-latest
    needs: validate-before-release
    if: inputs.publish_core == true
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v3.6.0
      
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.0.1
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        registry-url: 'https://registry.npmjs.org'
        
    - name: ğŸ“¦ Install dependencies
      run: npm ci
      
    - name: ğŸ”¨ Build warbler-core
      run: |
        cd packages/warbler-core
        npm run build
        
    - name: ğŸ·ï¸ Version bump (if not dry run)
      if: inputs.dry_run == false
      run: |
        cd packages/warbler-core
        npm version ${{ inputs.version_bump }} --no-git-tag-version
        echo "Version updated to $(node -e "console.log(require('./package.json').version)")"
        
    - name: ğŸš€ Publish warbler-core (dry run)
      if: inputs.dry_run == true
      run: |
        cd packages/warbler-core
        npm publish --dry-run
        echo "âœ… Dry run completed for warbler-core"
        
    - name: ğŸš€ Publish warbler-core (actual)
      if: inputs.dry_run == false
      run: |
        cd packages/warbler-core
        npm publish
        echo "âœ… Published warbler-core"
      env:
        NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  publish-packs:
    name: ğŸ“¦ Publish Content Packs
    runs-on: ubuntu-latest
    needs: [validate-before-release, publish-core]
    if: inputs.publish_packs == true && (success() || needs.publish-core.result == 'skipped')
    
    strategy:
      matrix:
        pack:
          - warbler-pack-core
          - warbler-pack-faction-politics
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v3.6.0
      
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.0.1
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        registry-url: 'https://registry.npmjs.org'
        
    - name: ğŸ“¦ Install dependencies
      run: npm ci
      
    - name: ğŸ”¨ Build pack
      run: |
        cd packs/${{ matrix.pack }}
        npm run build
        
    - name: ğŸ·ï¸ Version bump (if not dry run)
      if: inputs.dry_run == false
      run: |
        cd packs/${{ matrix.pack }}
        npm version ${{ inputs.version_bump }} --no-git-tag-version
        echo "Version updated to $(node -e "console.log(require('./package.json').version)")"
        
    - name: ğŸš€ Publish pack (dry run)
      if: inputs.dry_run == true
      run: |
        cd packs/${{ matrix.pack }}
        npm publish --dry-run
        echo "âœ… Dry run completed for ${{ matrix.pack }}"
        
    - name: ğŸš€ Publish pack (actual)
      if: inputs.dry_run == false
      run: |
        cd packs/${{ matrix.pack }}
        npm publish
        echo "âœ… Published ${{ matrix.pack }}"
      env:
        NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  release-summary:
    name: ğŸ“‹ Release Summary
    runs-on: ubuntu-latest
    needs: [validate-before-release, publish-core, publish-packs]
    if: always()
    
    steps:
    - name: ğŸ“Š Report results
      run: |
        echo "ğŸ­ Warbler Release Summary"
        echo "========================="
        echo "Validation: ${{ needs.validate-before-release.result }}"
        echo "Core publish: ${{ needs.publish-core.result }}"
        echo "Packs publish: ${{ needs.publish-packs.result }}"
        echo "Dry run: ${{ inputs.dry_run }}"
        echo "Version bump: ${{ inputs.version_bump }}"
        
        if [ "${{ needs.validate-before-release.result }}" == "success" ]; then
          echo "âœ… All validations passed"
        else
          echo "âŒ Validation failed"
        fi
        
        if [ "${{ inputs.dry_run }}" == "true" ]; then
          echo "ğŸ§ª This was a dry run - no packages were actually published"
        else
          echo "ğŸš€ Live publishing attempted"
        fi
        
        echo "ğŸ¯ Release workflow completed"